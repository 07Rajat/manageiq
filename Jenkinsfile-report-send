pipeline {
    agent any

    environment {
        // Set environment variables if needed
        PYTHON_PATH = "/usr/local/bin" // Default Python path
        VENV_DIR = "${WORKSPACE}/venv" // Virtual environment directory
    }

    parameters {
        string(name: 'MONGODB_URI', defaultValue: '', description: 'MongoDB connection URI')
        string(name: 'DATABASE', defaultValue: '', description: 'MongoDB database name')
        string(name: 'COLLECTIONS', defaultValue: '', description: 'Comma-separated list of collections')
        string(name: 'OPENAI_API_KEY', defaultValue: '', description: 'OpenAI API key')
        string(name: 'EMAIL_FROM', defaultValue: '', description: 'Sender email address')
        string(name: 'EMAIL_PASSWORD', defaultValue: '', description: 'Sender email password')
        string(name: 'EMAIL_TO', defaultValue: '', description: 'Comma-separated list of recipient email addresses')
        string(name: 'REPORT_DIR', defaultValue: 'reports', description: 'Directory to save reports (default: "reports")')
        string(name: 'RATE_LIMIT_DELAY', defaultValue: '1', description: 'Rate limit delay in seconds (default: 1)')
        string(name: 'GIT_BRANCH', defaultValue: 'main', description: 'Git branch to checkout (default: main)')
    }

    stages {
        stage('Checkout Repository') {
            steps {
                script {
                    echo "Checking out the repository..."
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "${params.GIT_BRANCH}"]],
                        userRemoteConfigs: [[url: 'https://github.com/07Rajat/manageiq.git']]
                    ])
                }
            }
        }

        stage('Install System Dependencies') {
            steps {
                script {
                    echo "Checking for system dependencies..."
                    def packages = [
                        "python3",
                        "python3-pip",
                        "python3-venv",
                        "libssl-dev",
                        "libffi-dev",
                        "libxml2-dev",
                        "libxslt1-dev",
                        "zlib1g-dev",
                        "libjpeg-dev",
                        "libpng-dev"
                    ]

                    // Check if each package is installed
                    def missingPackages = []
                    for (pkg in packages) {
                        def result = sh(script: "dpkg -l | grep -E '^ii\\s+${pkg}\\s'", returnStatus: true)
                        if (result != 0) {
                            missingPackages.add(pkg)
                        }
                    }

                    // Install missing packages
                    if (missingPackages) {
                        echo "Installing missing system dependencies: ${missingPackages}"
                        sh """
                        apt-get update && apt-get install -y ${missingPackages.join(" ")}
                        """
                    } else {
                        echo "All system dependencies are already installed."
                    }
                }
            }
        }

        stage('Set Up Virtual Environment') {
            steps {
                script {
                    echo "Setting up Python virtual environment..."
                    sh """
                    python3 -m venv ${VENV_DIR}
                    """
                }
            }
        }

        stage('Install Python Dependencies') {
            steps {
                script {
                    echo "Installing Python dependencies..."
                    sh """
                    . ${VENV_DIR}/bin/activate && \
                    pip install --upgrade pip && \
                    pip install pymongo[srv] openai matplotlib pandas openpyxl
                    """
                }
            }
        }

        stage('Generate Reports') {
            steps {
                script {
                    echo "Generating reports..."
                    catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                        sh """
                        . ${VENV_DIR}/bin/activate && \
                        python3 ./manageiq-jobs/scripts/generate_report.py \
                            --mongodb_uri "${params.MONGODB_URI}" \
                            --database "${params.DATABASE}" \
                            --collections "${params.COLLECTIONS}" \
                            --openai_api_key "${params.OPENAI_API_KEY}" \
                            --report_dir "${params.REPORT_DIR}" \
                            --rate_limit_delay "${params.RATE_LIMIT_DELAY}"
                        """
                    }
                }
            }
        }

        stage('Send Email') {
            steps {
                script {
                    echo "Sending email with reports..."
                    catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                        sh """
                        . ${VENV_DIR}/bin/activate && \
                        python3 ./manageiq-jobs/scripts/send_email.py \
                            --email_from "${params.EMAIL_FROM}" \
                            --email_password "${params.EMAIL_PASSWORD}" \
                            --email_to "${params.EMAIL_TO}" \
                            --report_dir "${params.REPORT_DIR}"
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Reports generated and email sent successfully!"
        }
        failure {
            echo "Failed to generate reports or send email. Check logs for errors."
        }
    }
}