pipeline {
    agent any

    parameters {
        string(name: 'IBM_API_KEY', defaultValue: '', description: 'IBM Cloud API key')
        string(name: 'REPO_URL', defaultValue: '', description: 'Git repository URL for Terraform code')
        string(name: 'TEAM_NAME', defaultValue: '', description: 'Enter the Team Name')
        string(name: 'DB_NAME', defaultValue: '', description: 'Enter the Database Name')
        string(name: 'MongoURL', defaultValue: '', description: 'Enter the Mongodb URL')
        string(name: 'REQUESTED_CPU', defaultValue: '', description: 'Requested CPU')
        string(name: 'REQUESTED_MEMORY', defaultValue: '', description: 'Requested Memory (GB)')
    }

    stages {

        stage('Install Dependencies') {
            steps {
                script {
                    // Create a virtual environment
                    sh 'python3 -m venv venv'
                    
                    // Activate the virtual environment and install pymongo
                    sh '''
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install --upgrade pip
                        pip install "pymongo[srv]"
                    '''
                }
            }
        }

        stage('Fetch Resource Allocation') {
            steps {
                script {
                    def teamName = params.TEAM_NAME
                    def requestedCPU = params.REQUESTED_CPU.toInteger()
                    def requestedMemory = params.REQUESTED_MEMORY.toInteger()
                    
                    // Activate the virtual environment and run the Python script
                    def fetchCommand = """
                        . venv/bin/activate
                        python3 ./manageiq-jobs/scripts/fetch_resources.py '${params.DB_NAME}' '${teamName}' '${params.MongoURL}'
                    """
                    def fetchOutput = sh(script: fetchCommand, returnStdout: true).trim()
                    
                    echo "Fetch output: ${fetchOutput}"

                    if (!fetchOutput?.trim()) {
                        error "Error: Fetch output is empty. Check if the script executed correctly."
                    }

                    // Parse JSON output from Python script
                    def resourceData = readJSON(text: fetchOutput)

                    if (resourceData.containsKey('error')) {
                        error "Error: ${resourceData.error}"
                    }
                    
                    def allocatedCPU = resourceData.allocated_cpu.toInteger()
                    def allocatedMemory = resourceData.allocated_memory_gb.toInteger()

                    // Compare Requested vs Allocated
                    if (requestedCPU > allocatedCPU || requestedMemory > allocatedMemory) {
                        error "Error: Requested resources exceed allocation! (Requested: ${requestedCPU} CPU, ${requestedMemory} GB RAM, Available: ${allocatedCPU} CPU, ${allocatedMemory} GB RAM)"
                    }

                    echo "Resources available. Proceeding with Terraform..."
                }
            }
        }

        stage('Run Create Cluster Script') {
            steps {
                script {

                    // Execute the script with parameters
                    sh """
                    chmod +x ./manageiq-jobs/scripts/create-openshift-cluster.sh
                    ./manageiq-jobs/scripts/create-openshift-cluster.sh --ibm-api-key ${IBM_API_KEY} --repo-url ${REPO_URL}
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Cluster creation completed successfully!"
        }
        failure {
            echo "Cluster creation failed. Check the logs for details."
        }
    }
}